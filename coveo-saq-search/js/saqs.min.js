var SAQS;!function(e){var t;!function(e){var t;!function(e){e.BASE_URL="https://cloudplatform.coveo.com",e.SEARCH_URI=e.BASE_URL+"/rest/search"}(t=e.API||(e.API={}))}(t=e.Const||(e.Const={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(e){var t;!function(e){e.addFilter="filter.add",e.afterAddFilter="filter.add.after",e.removeFilter="filter.remove",e.afterRemoveFilter="filter.remove.after",e.applyFilters="filter.apply",e.afterApplyFilters="filter.apply.after",e.loadProducts="product.load",e.performSearch="search.load"}(t=e.Events||(e.Events={}))}(t=e.Const||(e.Const={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(e){var t;!function(e){e.Sort={ASC:"fieldAscending",DESC:"fieldDescending"},e.ON_SPECIAL={title:"On Special",type:"checkbox",category:"tpenspecial",options:[{category:"tpenspecial",key:"on-special",label:"Only",bcDisplay:"On Special",value:!1,submitValue:!0,multi:!1}]},e.PRICE={title:"Price Range",type:"checkbox",category:"tpprixnum",options:[{category:"tpprixnum",key:"price_0-20",label:"$0 - $20",value:!1,submitValue:"0..20",multi:!1},{category:"tpprixnum",key:"price_21-50",label:"$21 - $50",value:!1,submitValue:"21..50",multi:!1},{category:"tpprixnum",key:"price_51-100",label:"$51 - $100",value:!1,submitValue:"51..100",multi:!1},{category:"tpprixnum",key:"price_100-",label:"Over $100",value:!1,submitValue:"100..100000",multi:!1}]},e.CATEGORY={title:"Category",type:"checkbox",category:"tpcategorie",options:[{category:"tpcategorie",key:"type_red-wine",label:"Red Wine",value:!1,submitValue:'"Vin rouge"',multi:!0},{category:"tpcategorie",key:"type_white-wine",label:"White Wine",submitValue:'"Vin blanc"',value:!1,multi:!0},{category:"tpcategorie",key:"type_rose",label:"Rosé",submitValue:'"Vin rosé"',value:!1,multi:!0},{category:"tpcategorie",key:"type_porto",label:"Porto",submitValue:"Porto",value:!1,multi:!0},{category:"tpcategorie",key:"type_whisky",label:"Whisky",submitValue:"Whisky",value:!1,multi:!0},{category:"tpcategorie",key:"type_dry-gin",label:"Dry Gin",submitValue:'"Dry gin"',value:!1,multi:!0}]},e.REGION={title:"Region",type:"checkbox",category:"tpregion",options:[{category:"tpregion",key:"region_california",label:"California",value:!1,submitValue:"californie",multi:!0},{category:"tpregion",key:"region_toscane",label:"Toscane",value:!1,submitValue:"toscane",multi:!0},{category:"tpregion",key:"region_bourgogne",label:"Bourgogne",value:!1,submitValue:"Bourgogne",multi:!0},{category:"tpregion",key:"region_bordeaux",label:"Bordeaux",value:!1,submitValue:"Bordeaux",multi:!0},{category:"tpregion",key:"region_quebec",label:"Québec",value:!1,submitValue:'"Québec"',multi:!0},{category:"tpregion",key:"region_vallee-du-rhone",label:"Vallée du Rhône",value:!1,submitValue:'"Vallée du Rhône"',multi:!0}]},e.COUNTRY={title:"Country",type:"checkbox",category:"tppays",options:[{category:"tppays",key:"country_france",label:"France",value:!1,submitValue:"france",multi:!0},{category:"tppays",key:"country_us",label:"U.S.",value:!1,submitValue:"etats-unis",multi:!0},{category:"tppays",key:"country_italy",label:"Italy",value:!1,submitValue:"italie",multi:!0},{category:"tppays",key:"country_canada",label:"Canada",value:!1,submitValue:"Canada",multi:!0},{category:"tppays",key:"country_spain",label:"Spain",value:!1,submitValue:"Espagne",multi:!0},{category:"tppays",key:"country_portugal",label:"Portugal",value:!1,submitValue:"Portugal",multi:!0}]},e.ALL_FILTERS=[e.ON_SPECIAL,e.PRICE,e.CATEGORY,e.REGION,e.COUNTRY]}(t=e.Filters||(e.Filters={}))}(t=e.Const||(e.Const={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(e){var t;!function(e){e.FAVORITE_PRODUCTS="saqs.products.favorites"}(t=e.LocalStorage||(e.LocalStorage={}))}(t=e.Const||(e.Const={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(e){var t;!function(e){e.DEFAULT_LIMIT=12}(t=e.Paging||(e.Paging={}))}(t=e.Const||(e.Const={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(e){var t;!function(e){var t="/coveo-saq-search/templates/";e.HOME_TPL=t+"home.html",e.NOT_FOUND_TPL=t+"not-found.html",e.SEARCH_BAR_TPL=t+"directives/search-bar.html",e.SIDE_FILTER_TPL=t+"directives/side-filter.html",e.PRODUCT_FILTER_TPL=t+"directives/product-filter.html",e.PRODUCT_LIST_TPL=t+"directives/product-list.html",e.BREADCRUMB_TPL=t+"directives/breadcrumbs.html",e.PAGING_TPL=t+"directives/paging.html"}(t=e.Templates||(e.Templates={}))}(t=e.Const||(e.Const={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t=e.Const.Templates;angular.module("saqs.services",[]),angular.module("saqs.directives",[]),angular.module("saqs",["ngRoute","saqs.services","saqs.directives"]),angular.module("saqs").constant("_",_),angular.module("saqs").config(["$routeProvider","$compileProvider",function(e,r){r.debugInfoEnabled(!1),e.when("/",{templateUrl:t.HOME_TPL}).otherwise({templateUrl:t.NOT_FOUND_TPL})}])}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r=e.Const.Templates;angular.module("saqs.directives").directive("breadCrumbs",["EventBus",function(t){return{restrict:"E",scope:{},templateUrl:r.BREADCRUMB_TPL,link:function(r){r.itemCount=0,r.totalItemCount=0,r.crumbs=[],r.removeCrumb=function(r){t.publish(e.Const.Events.removeFilter,r)},r.removeAll=function(){var i=angular.copy(r.crumbs);i.forEach(function(r){r.skipApply=!0,t.publish(e.Const.Events.removeFilter,r)}),t.publish(e.Const.Events.applyFilters)},t.subscribe(e.Const.Events.addFilter,r,function(e){var t=_.findIndex(r.crumbs,{key:e.key});t>-1&&r.crumbs.splice(t,1),e.bcDisplay!==!1&&r.crumbs.push(e)}),t.subscribe(e.Const.Events.removeFilter,r,function(e){r.crumbs.splice(_.findIndex(r.crumbs,{key:e.key}),1)}),t.subscribe(e.Const.Events.loadProducts,r,function(e){r.itemCount=e.results.length,r.totalItemCount=e.totalCount})}}}])}(t=e.Directives||(e.Directives={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r=e.Const.Templates;angular.module("saqs.directives").directive("paging",["EventBus","DB",function(t,i){return{restrict:"E",scope:{},templateUrl:r.PAGING_TPL,link:function(r){r.curPage=1,r.totalPages=1,r.prev=function(){var n=i.getPaging(),o=n.offset-n.limit;i.setPaging({limit:n.limit,offset:o<0?0:o}),t.publish(e.Const.Events.performSearch),r.curPage>1&&(r.curPage-=1)},r.next=function(){var n=i.getPaging(),o=n.offset+n.limit;i.setPaging({limit:n.limit,offset:o>r.totalPages*n.limit?r.totalPages*n.limit:o}),t.publish(e.Const.Events.performSearch),r.curPage<r.totalPages&&(r.curPage+=1)},t.subscribe(e.Const.Events.loadProducts,r,function(e){var t=i.getPaging();r.totalPages=Math.ceil(e.totalCount/t.limit),0===e.results.length?r.curPage=0:r.curPage=Math.floor(t.offset/t.limit)+1}),t.subscribe(e.Const.Events.applyFilters,r,function(){var e=i.getPaging();i.setPaging({limit:e.limit,offset:0}),r.curPage=1},1)}}}])}(t=e.Directives||(e.Directives={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r=e.Const.Templates;angular.module("saqs.directives").directive("productFilter",["_","DB","EventBus",function(t,i,n){return{restrict:"E",scope:{filter:"="},templateUrl:r.PRODUCT_FILTER_TPL,link:function(t){t.onChange=function(t,r){switch(r.type){case"checkbox":var i=t.value===!0?e.Const.Events.addFilter:e.Const.Events.removeFilter;t.multi===!1&&r.options.forEach(function(r){r.key!==t.key&&r.value===!0&&(r.skipApply=!0,r.value=!1,n.publish(e.Const.Events.removeFilter,r))}),n.publish(i,t)}}}}}])}(t=e.Directives||(e.Directives={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r=e.Const.Templates;angular.module("saqs.directives").directive("productList",["$window","DB","EventBus",function(t,i,n){return{restrict:"E",scope:{},templateUrl:r.PRODUCT_LIST_TPL,link:function(r,n){r.products=i.getProducts(),r.openProduct=function(e){e&&e.clickUri&&t.open(e.clickUri)},r.favoriteProduct=function(r,i){i.preventDefault(),i.stopPropagation();var n=e.Const.LocalStorage.FAVORITE_PRODUCTS,o=t.localStorage.getItem(n),a=o?JSON.parse(o):{};r._favorite===!0?(r._favorite=!1,delete a[r.uniqueId]):(r._favorite=!0,a[r.uniqueId]=!0),t.localStorage.setItem(n,JSON.stringify(a))}}}}])}(t=e.Directives||(e.Directives={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r=e.Const.Templates;angular.module("saqs.directives").directive("searchBar",["EventBus","Filter",function(t,i){return{restrict:"E",scope:{},templateUrl:r.SEARCH_BAR_TPL,link:function(r,i){t.publish(e.Const.Events.applyFilters);var n=i.find("input");n.bind("keydown",function(r){if(13===r.which){var i=n.val();t.publish(e.Const.Events.addFilter,{category:"main-search",key:"main-search",label:"",bcDisplay:i,multi:!1,value:i,submitValue:i}),n.val("")}})}}}])}(t=e.Directives||(e.Directives={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r=e.Const.Templates;angular.module("saqs.directives").directive("sideFilter",[function(){return{restrict:"E",scope:{},templateUrl:r.SIDE_FILTER_TPL,link:function(t){t.filters=e.Const.Filters.ALL_FILTERS}}}])}(t=e.Directives||(e.Directives={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r,i=function(){function t(t,i,n){this.$parse=t,this._=i,this.EventBus=n,r=this,r._db={filters:{},products:[],sort:{field:"tpmillesime",dir:e.Const.Filters.Sort.DESC},paging:{offset:0,limit:e.Const.Paging.DEFAULT_LIMIT}},n.subscribe(e.Const.Events.addFilter,r,r.addFilter),n.subscribe(e.Const.Events.removeFilter,r,r.removeFilter),n.subscribe(e.Const.Events.loadProducts,r,r.loadProducts)}return t.prototype.addFilter=function(t){t&&(t.multi?(r._db.filters[t.category]=r._db.filters[t.category]||[],r._db.filters[t.category].push(t)):r._db.filters[t.category]=t,r.EventBus.publish(e.Const.Events.afterAddFilter,t),r.EventBus.publish(e.Const.Events.applyFilters))},t.prototype.removeFilter=function(t){var i=r._db.filters;if(i&&i[t.category]){if(t.multi){var n=i[t.category];n.splice(_.findIndex(n,{key:t.key}),1),0===n.length&&delete i[t.category]}else delete i[t.category];r.EventBus.publish(e.Const.Events.afterRemoveFilter,t),t.skipApply!==!0&&r.EventBus.publish(e.Const.Events.applyFilters)}var o=r._.findIndex(e.Const.Filters.ALL_FILTERS,{category:t.category}),a=e.Const.Filters.ALL_FILTERS[o];if(a)if(t.multi){if(o=r._.findIndex(a.options,{key:t.key}),a.options[o])switch(a.type){case"checkbox":a.options[o].value=!1}}else switch(a.type){case"checkbox":var s=r._.find(a.options,{key:t.key})||{};s.value=!1}},t.prototype.loadProducts=function(e){var t=e.results,i=r.getProducts();i.splice(0,i.length),i.push.apply(i,t)},t.prototype.getFilters=function(){return r.$parse("_db.filters")(r)},t.prototype.getProducts=function(){return r.$parse("_db.products")(r)},t.prototype.getSorting=function(){return r.$parse("_db.sort")(r)},t.prototype.getPaging=function(){return r.$parse("_db.paging")(r)},t.prototype.setPaging=function(e){r._db.paging=e},t}();i.$inject=["$parse","_","EventBus"],t.DB=i,angular.module("saqs.services").service("DB",i)}(t=e.Services||(e.Services={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(e){var t,r=function(){function e(){t=this,t._topics={},t._subUid=-1}return e.prototype.subscribe=function(e,r,i,n){t._topics[e]||(t._topics[e]=[]);var o=(++t._subUid).toString();return t._topics[e].push({token:o,handler:i,scope:r,priority:n||1e4}),o},e.prototype.publish=function(e,r){if(!t._topics[e])return!1;var i=t._topics[e],n=i?i.length:0;return n>0&&i.sort(function(e,t){return e.priority-t.priority}).forEach(function(e){angular.isFunction(e.handler)&&e.handler.call(e.scope,r)}),!0},e.prototype.unsubscribe=function(e){for(var r in t._topics)if(t._topics[r])for(var i=0,n=t._topics[r].length;i<n;i++)if(t._topics[r][i].token===e)return t._topics[r].splice(i,1),!0;return!1},e}();e.EventBus=r,angular.module("saqs.services").service("EventBus",r)}(t=e.Services||(e.Services={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r,i=function(){function t(t,i,n,o){this.$rootScope=t,this.EventBus=i,this.DB=n,this.Product=o,r=this,i.subscribe(e.Const.Events.applyFilters,r,r.applyFilters),i.subscribe(e.Const.Events.performSearch,r,r.performSearch)}return t.prototype.buildSearchReq=function(){var e=r.DB.getFilters(),t=Object.keys(e).map(function(t){return e[t]});return{filters:t,sort:r.DB.getSorting(),paging:r.DB.getPaging()}},t.prototype.performSearch=function(){r.$rootScope.loading=!0,r.Product.search(r.buildSearchReq()).then(function(t){r.EventBus.publish(e.Const.Events.loadProducts,t),r.$rootScope.loading=!1}).catch(function(e){alert("Error searching for products"),r.$rootScope.loading=!1})},t.prototype.applyFilters=function(){r.performSearch()},t}();i.$inject=["$rootScope","EventBus","DB","Product"],t.Filter=i,angular.module("saqs.services").service("Filter",i)}(t=e.Services||(e.Services={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r,i=function(){function t(t,i,n,o,a){this.$window=t,this.$q=i,this.$http=n,this.EventBus=o,this.ReqBuilder=a,r=this,o.subscribe(e.Const.Events.performSearch,r,r.performSearch)}return t.prototype.search=function(e){var t=r.$q.defer(),i=r.ReqBuilder.getUri(e),n=r.ReqBuilder.getData(e);return r.$http.post(i,n).then(function(e){r.enrich(e.data),t.resolve(e.data)}).catch(function(e){t.reject(e)}),t.promise},t.prototype.enrich=function(t){var i=e.Const.LocalStorage.FAVORITE_PRODUCTS,n=r.$window.localStorage.getItem(i),o=n?JSON.parse(n):{};t.results.forEach(function(e){e._favorite=!!o[e.uniqueId],e.raw.tpthumbnailuri=e.raw.tpthumbnailuri.replace("http","https")})},t}();i.$inject=["$window","$q","$http","EventBus","ReqBuilder"],t.Product=i,angular.module("saqs.services").service("Product",i)}(t=e.Services||(e.Services={}))}(SAQS||(SAQS={}));var SAQS;!function(e){var t;!function(t){var r,i=function(){function t(t){this._=t,this.defaultSearchReqData={aq:"",searchHub:"default",language:"en",pipeline:"default",firstResult:0,numberOfResults:e.Const.Paging.DEFAULT_LIMIT,excerptLength:200,filterField:null,enableDidYouMean:!0,sortCriteria:"fieldDescending",sortField:"@tpmillesime",queryFunctions:[],rankingFunctions:[],retrieveFirstSentences:!0,timezone:"America/New_York",enableDuplicateFiltering:!1,enableCollaborativeRating:!1},r=this}return t.prototype.getUri=function(t){return e.Const.API.SEARCH_URI+"?"+r.getApiKey()},t.prototype.getData=function(e){var t=angular.extend({},r.defaultSearchReqData,{aq:r.getFilters(e.filters),q:r.getMainSearch(e.filters),sortField:"@"+e.sort.field,sortCriteria:e.sort.dir,firstResult:e.paging.offset,numberOfResults:e.paging.limit});return t},t.prototype.getApiKey=function(){var e=window.ACCESS_TOKEN||"";return"access_token="+e},t.prototype.getMainSearch=function(e){return(r._.find(e,{key:"main-search"})||{}).submitValue},t.prototype.getFilters=function(e){var t={};e.forEach(function(e){angular.isArray(e)&&e.length>0?t[e[0].category]=e:t[e.category]=e});var r=Object.keys(t);return r.reduce(function(e,r){if("main-search"!==r){var i=t[r];angular.isArray(i)&&i.length>0?i.length>1?(e+="(@"+r+"==(",i.forEach(function(t,r){e+=t.submitValue,e+=r<i.length-1?",":""}),e+="))"):e+="(@"+r+"=="+i[0].submitValue+")":e+="(@"+r+"=="+i.submitValue+")"}return e},"")},t}();i.$inject=["_"],t.ReqBuilder=i,angular.module("saqs.services").service("ReqBuilder",i)}(t=e.Services||(e.Services={}))}(SAQS||(SAQS={}));